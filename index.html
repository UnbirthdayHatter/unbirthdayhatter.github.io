<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FFXIV Mitigation Planner</title>
    <!-- Robust CDNs for React, ReactDOM, and Babel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js" crossorigin></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7/babel.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { height: 12px; width: 12px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #171717; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #404040; border-radius: 6px; border: 3px solid #171717; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #525252; }
    </style>
</head>
<body class="bg-neutral-900 text-neutral-100 font-sans h-screen overflow-hidden">
    <div id="root" class="h-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- INLINE ICON COMPONENTS ---
        const Shield = ({ className }) => (<svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2-1 4.2-2 7-2c2.8 0 5 1 7 2a1 1 0 0 1 1 1v7z"/></svg>);
        const Trash2 = ({ className }) => (<svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>);
        const GripHorizontal = ({ className }) => (<svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="9" r="1"/><circle cx="19" cy="9" r="1"/><circle cx="5" cy="9" r="1"/><circle cx="12" cy="15" r="1"/><circle cx="19" cy="15" r="1"/><circle cx="5" cy="15" r="1"/></svg>);
        const Activity = ({ className }) => (<svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>);
        const AlertCircle = ({ className }) => (<svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>);
        const Info = ({ className }) => (<svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>);
        const SettingsIcon = ({ className }) => (<svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>);

        // --- CONFIGURATION & SKILL DATA ---
        const PIXELS_PER_SECOND = 15; 
        const BOSS_AREA_HEIGHT = 180;

        // Damage Parser & Color Gradients
        const parseDamage = (dmgStr) => {
          if (!dmgStr) return 0;
          let s = dmgStr.toString().toLowerCase().replace(/,/g, '');
          let match = s.match(/(\d+)\s*[x*]\s*(\d+)/);
          if (match) return parseInt(match[1]) * parseInt(match[2]);
          let numMatch = s.match(/\d+/);
          if (numMatch) {
              let val = parseInt(numMatch[0]);
              if (s.includes('k')) val *= 1000;
              return val;
          }
          return 0;
        };

        const getDamageColor = (dmg, maxDmg) => {
          if (!dmg || !maxDmg) return 'rgb(250, 204, 21)'; // Default Yellow
          const ratio = Math.min(1, dmg / maxDmg);
          const r = Math.round(250 + ratio * (239 - 250));
          const g = Math.round(204 + ratio * (68 - 204));
          const b = Math.round(21 + ratio * (68 - 21));
          return `rgb(${r}, ${g}, ${b})`;
        };

        const JOBS = {
          "Sage": [
            { name: "Kerachole", duration: 15, cd: 30, effect: "10% mit + 500p Regen", color: "bg-blue-500", mitPercent: 10, hotPotency: 100, hotTicks: 5 },
            { name: "Haima", duration: 15, cd: 120, effect: "300p ×5 shields", color: "bg-blue-400", shieldPotency: 300, shieldStacks: 5 },
            { name: "Panhaima", duration: 15, cd: 120, effect: "200p ×5 shields", color: "bg-blue-300", shieldPotency: 200, shieldStacks: 5 },
            { name: "Holos", duration: 20, cd: 120, effect: "300p heal + 10% mit", color: "bg-teal-500", mitPercent: 10, healPotency: 300 },
            { name: "Physis II", duration: 15, cd: 60, effect: "650p Regen + 10% healing up", color: "bg-green-500", hotPotency: 130, hotTicks: 5 },
            { name: "Zoe", duration: 30, cd: 90, effect: "+50% next GCD heal", color: "bg-yellow-500" },
            { name: "Philosophia", duration: 20, cd: 120, effect: "+20% healing done", color: "bg-purple-500" },
            { name: "Pneuma", duration: 1, cd: 120, effect: "600p AoE heal", color: "bg-cyan-400", healPotency: 600 } 
          ],
          "Astrologian": [
            { name: "Macrocosmos", duration: 15, cd: 180, effect: "Damage compilation heal", color: "bg-indigo-500", healPotency: 250 },
            { name: "Earthly Star", duration: 20, cd: 60, effect: "Delayed massive heal/dmg", color: "bg-yellow-400", healPotency: 720 },
            { name: "Collective Unconscious", duration: 5, cd: 60, effect: "10% mit + Regen", color: "bg-blue-600", mitPercent: 10, hotPotency: 100, hotTicks: 5 }
          ],
          "White Mage": [
            { name: "Temperance", duration: 20, cd: 120, effect: "10% mit + 20% healing", color: "bg-blue-300", mitPercent: 10 },
            { name: "Liturgy of the Bell", duration: 15, cd: 180, effect: "Reactive AoE heal", color: "bg-teal-400", shieldPotency: 400, shieldStacks: 5 },
            { name: "Divine Caress", duration: 15, cd: 0, effect: "AoE Shield (Req Temperance)", color: "bg-white border text-black", shieldPotency: 400 }
          ],
          "Scholar": [
            { name: "Expedient", duration: 20, cd: 120, effect: "10% mit + Sprint", color: "bg-emerald-500", mitPercent: 10 },
            { name: "Sacred Soil", duration: 15, cd: 30, effect: "10% mit + Regen", color: "bg-purple-600", mitPercent: 10, hotPotency: 100, hotTicks: 5 },
            { name: "Seraphism", duration: 20, cd: 180, effect: "Enhanced shields/healing", color: "bg-yellow-200 text-black" }
          ],
          "Paladin": [
            { name: "Divine Veil", duration: 30, cd: 90, effect: "AoE Shield + Heal", color: "bg-yellow-500", shieldPotency: 400, healPotency: 400 },
            { name: "Passage of Arms", duration: 18, cd: 120, effect: "15% AoE mit (channeled)", color: "bg-blue-400", mitPercent: 15 },
            { name: "Reprisal", duration: 15, cd: 60, effect: "10% boss damage down", color: "bg-red-500", mitPercent: 10 }
          ],
          "Warrior": [
            { name: "Shake It Off", duration: 30, cd: 90, effect: "AoE Shield + Regen", color: "bg-orange-500", shieldPotency: 700, hotPotency: 100, hotTicks: 5 },
            { name: "Reprisal", duration: 15, cd: 60, effect: "10% boss damage down", color: "bg-red-500", mitPercent: 10 }
          ],
          "Dark Knight": [
            { name: "Dark Missionary", duration: 15, cd: 90, effect: "10% AoE magic mit", color: "bg-purple-700", mitPercent: 10 },
            { name: "Reprisal", duration: 15, cd: 60, effect: "10% boss damage down", color: "bg-red-500", mitPercent: 10 }
          ],
          "Gunbreaker": [
            { name: "Heart of Light", duration: 15, cd: 90, effect: "10% AoE magic mit", color: "bg-yellow-600", mitPercent: 10 },
            { name: "Reprisal", duration: 15, cd: 60, effect: "10% boss damage down", color: "bg-red-500", mitPercent: 10 }
          ]
        };

        const FIGHT_TABS = ["M9S", "M10S", "M11S", "M12S P1", "M12S P2"];
        const SHEET_ID = "1kGvAGi_YmYu2wz8fgm9ZIYuA51TpmHlwQijkV01ki6E";

        const parseTime = (timeStr) => {
          if (!timeStr) return null;
          const cleanStr = String(timeStr).replace(/[\(\)]/g, '').trim();
          if (cleanStr.includes(':')) {
            const [m, s] = cleanStr.split(':');
            return parseInt(m) * 60 + parseInt(s);
          }
          return parseInt(cleanStr) || null;
        };

        const parseCSV = (csvText) => {
          const lines = csvText.split('\n');
          const data = [];
          let headerFound = false;
          
          for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;

            const row = [];
            let current = '';
            let inQuotes = false;
            for (let char of line) {
              if (char === '"') inQuotes = !inQuotes;
              else if (char === ',' && !inQuotes) {
                row.push(current.replace(/^"|"$/g, '').trim());
                current = '';
              } else {
                current += char;
              }
            }
            row.push(current.replace(/^"|"$/g, '').trim());

            if (!headerFound) {
              if (row.some(c => c.toLowerCase().includes('cast name'))) {
                headerFound = true;
              }
              continue;
            }

            if (row.length >= 4) {
              const timeInSeconds = parseTime(row[1]);
              if (timeInSeconds !== null && row[2]) {
                data.push({
                  section: row[0] || '',
                  timeStr: row[1],
                  seconds: timeInSeconds,
                  name: row[2],
                  damage: row[3] || '',
                  numDamage: parseDamage(row[3]),
                  type: row[4] || '',
                  notes: row[5] || ''
                });
              }
            }
          }
          return data;
        };

        function App() {
          const [selectedFight, setSelectedFight] = useState(FIGHT_TABS[0]);
          const [selectedJob, setSelectedJob] = useState("Sage");
          const [fightData, setFightData] = useState([]);
          const [isLoading, setIsLoading] = useState(false);
          const [error, setError] = useState(null);
          
          const [allMitigations, setAllMitigations] = useState({}); 
          const mitigations = allMitigations[selectedFight] || [];
          const timelineRef = useRef(null);

          // AkhMorning FFXIV Formula Stats (Defaults to approx. Level 100 Dawntrail scaling -> ~45 HP per Potency)
          const [showSettings, setShowSettings] = useState(false);
          const [stats, setStats] = useState({
            fHMP: 1600,
            fDET: 1100,
            fWD: 200,
            fTNC: 1000,
            fSPD: 1000,
            trait: 130 // Maim and Mend II (1.3)
          });

          // Formula implemention
          const calcDirectHeal = (potency) => {
            if (!potency) return 0;
            let h1 = Math.floor(Math.floor(Math.floor(potency * stats.fHMP * stats.fDET) / 100) / 1000);
            let h2 = Math.floor(Math.floor(Math.floor(Math.floor(h1 * stats.fTNC) / 1000) * stats.fWD) / 100) * stats.trait / 100;
            return Math.floor(h2);
          };

          const calcHoT = (potency, ticks) => {
            if (!potency) return 0;
            let h1 = Math.floor(Math.floor(Math.floor(potency * stats.fHMP * stats.fDET) / 100) / 1000);
            let h2 = Math.floor(Math.floor(Math.floor(Math.floor(Math.floor(h1 * stats.fTNC) / 1000) * stats.fSPD) / 1000) * stats.fWD) / 100) * stats.trait / 100;
            return Math.floor(h2) * ticks;
          };

          const getSkillHealingTotal = (skill) => {
              let hp = 0;
              if (skill.healPotency) hp += calcDirectHeal(skill.healPotency);
              if (skill.shieldPotency) hp += calcDirectHeal(skill.shieldPotency) * (skill.shieldStacks || 1);
              if (skill.hotPotency) hp += calcHoT(skill.hotPotency, skill.hotTicks || 1);
              return hp;
          }

          useEffect(() => {
            const fetchFightData = async () => {
              setIsLoading(true);
              setError(null);
              try {
                const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(selectedFight)}`;
                const response = await fetch(url);
                if (!response.ok) throw new Error("Failed to fetch Google Sheet");
                const csvText = await response.text();
                const parsedData = parseCSV(csvText);
                setFightData(parsedData);
              } catch (err) {
                setError(err.message);
              } finally {
                setIsLoading(false);
              }
            };
            fetchFightData();
          }, [selectedFight]);

          const maxSeconds = fightData.length > 0 ? Math.max(...fightData.map(d => d.seconds || 0), 1) + 60 : 600;
          const timelineWidth = maxSeconds * PIXELS_PER_SECOND;

          // Compute damage & healing stats
          const maxDamage = fightData.length > 0 ? Math.max(...fightData.map(d => d.numDamage || 0), 1) : 1;
          let totalRawDamage = 0;
          let totalMitigatedDamage = 0;
          let totalHealingDone = 0;

          fightData.forEach(attack => {
              totalRawDamage += attack.numDamage || 0;
              let damageMulti = 1.0;
              mitigations.forEach(mit => {
                  if (attack.seconds >= mit.startTime && attack.seconds <= mit.startTime + mit.skill.duration) {
                      if (mit.skill.mitPercent) {
                          damageMulti *= (1 - (mit.skill.mitPercent / 100));
                      }
                  }
              });
              totalMitigatedDamage += (attack.numDamage || 0) * (1 - damageMulti);
          });

          mitigations.forEach(mit => {
             totalHealingDone += getSkillHealingTotal(mit.skill);
          });

          const mitigatedPercent = totalRawDamage > 0 ? ((totalMitigatedDamage / totalRawDamage) * 100).toFixed(1) : 0;

          // Drag Start Handlers
          const handleDragStartPalette = (e, skill) => {
            e.dataTransfer.setData('text/plain', JSON.stringify({ type: 'palette', skill }));
            e.dataTransfer.effectAllowed = 'all';
          };

          const handleDragStartTimeline = (e, mit) => {
            e.dataTransfer.setData('text/plain', JSON.stringify({ type: 'timeline', mitId: mit.id, skill: mit.skill }));
            e.dataTransfer.effectAllowed = 'all';
          };

          const handleDragEnter = (e) => { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; };
          const handleDragOver = (e) => { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; };

          const handleDrop = (e) => {
            e.preventDefault();
            if (!timelineRef.current) return;

            const dataRaw = e.dataTransfer.getData('text/plain');
            if (!dataRaw) return;
            const data = JSON.parse(dataRaw);

            const rect = timelineRef.current.getBoundingClientRect();
            const dropX = e.clientX - rect.left + timelineRef.current.scrollLeft;
            let dropTime = Math.max(0, Math.round(dropX / PIXELS_PER_SECOND));

            const dropY = e.clientY - rect.top + timelineRef.current.scrollTop;
            let targetLane = Math.max(0, Math.floor((dropY - BOSS_AREA_HEIGHT) / 50));
            
            if (dropY < BOSS_AREA_HEIGHT) targetLane = 0;

            if (data.type === 'palette') {
              setAllMitigations(prev => {
                const currentMits = prev[selectedFight] || [];
                return {
                  ...prev,
                  [selectedFight]: [...currentMits, { id: Math.random().toString(36).substr(2, 9), skill: data.skill, startTime: dropTime, lane: targetLane }]
                };
              });
            } else if (data.type === 'timeline') {
              setAllMitigations(prev => {
                const currentMits = prev[selectedFight] || [];
                return {
                  ...prev,
                  [selectedFight]: currentMits.map(m => m.id === data.mitId ? { ...m, startTime: dropTime, lane: targetLane } : m)
                };
              });
            }
          };

          const deleteMitigation = (id) => {
            setAllMitigations(prev => {
              const currentMits = prev[selectedFight] || [];
              return { ...prev, [selectedFight]: currentMits.filter(m => m.id !== id) };
            });
          };

          const clearAll = () => {
            // Removed window.confirm to avoid Canvas/sandbox popup blocking
            setAllMitigations(prev => ({ ...prev, [selectedFight]: [] }));
          }

          const renderTimeMarkers = () => {
            const markers = [];
            for (let i = 0; i <= maxSeconds; i += 10) {
              const isMajor = i % 30 === 0;
              const mins = Math.floor(i / 60);
              const secs = (i % 60).toString().padStart(2, '0');
              markers.push(
                <div 
                  key={i} 
                  className={`absolute top-0 border-l ${isMajor ? 'border-gray-500' : 'border-gray-700/50'} h-full text-xs text-gray-400 pl-1 pt-1 pointer-events-none`} 
                  style={{ left: `${i * PIXELS_PER_SECOND}px` }}
                >
                  {isMajor ? `${mins}:${secs}` : ''}
                </div>
              );
            }
            return markers;
          };

          return (
            <div className="flex flex-col h-screen bg-neutral-900 text-neutral-100 font-sans overflow-hidden">
              <header className="flex items-center justify-between px-6 py-4 bg-neutral-800 border-b border-neutral-700 shadow-md z-10">
                <div className="flex items-center gap-3">
                  <Shield className="w-8 h-8 text-blue-400" />
                  <h1 className="text-xl font-bold tracking-tight">FFXIV Mit Planner</h1>
                </div>
                
                <div className="flex gap-4 items-center">
                  <div className="flex flex-col text-right text-xs mr-4 bg-neutral-900 px-3 py-1 rounded border border-neutral-700">
                    <div className="text-gray-400">Total Boss Dmg: <span className="text-white font-mono">{(totalRawDamage || 0).toLocaleString()}</span></div>
                    <div className="text-green-400">Mitigated: <span className="font-mono">{(Math.round(totalMitigatedDamage) || 0).toLocaleString()} ({mitigatedPercent}%)</span></div>
                    <div className="text-blue-400">Healed/Shielded: <span className="font-mono">{(totalHealingDone || 0).toLocaleString()}</span></div>
                  </div>

                  <select 
                    className="bg-neutral-700 border border-neutral-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 outline-none"
                    value={selectedFight}
                    onChange={(e) => setSelectedFight(e.target.value)}
                  >
                    {FIGHT_TABS.map(tab => <option key={tab} value={tab}>{tab}</option>)}
                  </select>

                  <select 
                    className="bg-neutral-700 border border-neutral-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 outline-none"
                    value={selectedJob}
                    onChange={(e) => setSelectedJob(e.target.value)}
                  >
                    {Object.keys(JOBS).map(job => <option key={job} value={job}>{job}</option>)}
                  </select>
                  
                  <button onClick={() => setShowSettings(!showSettings)} className="bg-neutral-600 hover:bg-neutral-500 px-3 py-2 rounded-lg transition-colors" title="Formula Settings">
                    <SettingsIcon className="w-5 h-5 text-white" />
                  </button>

                  <button onClick={clearAll} className="bg-red-600/80 hover:bg-red-600 px-4 py-2 rounded-lg text-sm font-semibold transition-colors">
                    Clear Plan
                  </button>
                </div>
              </header>

              <div className="flex flex-1 overflow-hidden relative">
                
                {/* --- SETTINGS MODAL --- */}
                {showSettings && (
                    <div className="absolute top-0 right-0 m-4 bg-neutral-800 border border-neutral-600 rounded-lg shadow-2xl z-50 p-4 w-80">
                        <div className="flex justify-between items-center mb-4 border-b border-neutral-700 pb-2">
                            <h3 className="font-bold text-sm">AkhMorning Formula Settings</h3>
                            <button onClick={() => setShowSettings(false)} className="text-neutral-400 hover:text-white">x</button>
                        </div>
                        <p className="text-xs text-neutral-400 mb-4">Adjust the f() multipliers used to calculate raw HP. Defaults simulate Lvl 100.</p>
                        
                        <div className="grid grid-cols-2 gap-3 mb-4">
                            {[
                                {label: 'f(HMP)', key: 'fHMP'}, {label: 'f(DET)', key: 'fDET'},
                                {label: 'f(WD)', key: 'fWD'}, {label: 'f(TNC)', key: 'fTNC'},
                                {label: 'f(SPD)', key: 'fSPD'}, {label: 'Trait %', key: 'trait'}
                            ].map(st => (
                                <div key={st.key} className="flex flex-col">
                                    <label className="text-[10px] text-neutral-400 uppercase font-bold">{st.label}</label>
                                    <input 
                                        type="number" 
                                        className="bg-neutral-900 border border-neutral-700 text-sm rounded px-2 py-1 text-white"
                                        value={stats[st.key]} 
                                        onChange={(e) => setStats({...stats, [st.key]: parseInt(e.target.value) || 0})}
                                    />
                                </div>
                            ))}
                        </div>
                    </div>
                )}

                <div className="w-80 bg-neutral-800 border-r border-neutral-700 p-4 flex flex-col gap-4 overflow-y-auto" style={{ scrollbarWidth: 'thin', scrollbarColor: '#404040 #171717' }}>
                  <div className="flex items-center gap-2 mb-2">
                    <Activity className="w-5 h-5 text-neutral-400" />
                    <h2 className="text-lg font-semibold">{selectedJob} Skills</h2>
                  </div>
                  
                  <p className="text-xs text-neutral-400 mb-2">Drag a skill onto the timeline below. Active duration is solid, cooldown is striped.</p>

                  <div className="flex flex-col gap-3">
                    {JOBS[selectedJob].map((skill, idx) => {
                      const totalHp = getSkillHealingTotal(skill);
                      return (
                        <div 
                          key={idx}
                          draggable
                          onDragStart={(e) => handleDragStartPalette(e, skill)}
                          className="group bg-neutral-700 rounded-lg p-3 cursor-grab active:cursor-grabbing hover:bg-neutral-600 transition-colors border border-neutral-600 hover:border-blue-400"
                        >
                          <div className="flex justify-between items-center mb-1">
                            <span className="font-bold text-sm flex items-center gap-2 pointer-events-none">
                              <GripHorizontal className="w-4 h-4 text-neutral-500 group-hover:text-white transition-colors"/> 
                              {skill.name}
                            </span>
                            <span className="text-xs font-mono text-neutral-400 pointer-events-none">{skill.cd}s CD</span>
                          </div>
                          <div className="text-xs text-neutral-300 mb-1 pointer-events-none">{skill.effect}</div>
                          {totalHp > 0 && (
                            <div className="text-[10px] text-green-400 font-mono mb-2 pointer-events-none">+{totalHp.toLocaleString()} HP</div>
                          )}
                          
                          <div className="h-2 w-full bg-neutral-800 rounded-full overflow-hidden flex pointer-events-none">
                            {/* Gracefully handle cd: 0 to prevent Infinity width calculation */}
                            <div className={`h-full ${skill.color}`} style={{ width: `${skill.cd > 0 ? (skill.duration / skill.cd) * 100 : 100}%`, minWidth: '5%' }}></div>
                            <div className="h-full bg-neutral-500/30 flex-1" style={{ backgroundImage: 'repeating-linear-gradient(45deg, transparent, transparent 5px, rgba(255,255,255,0.1) 5px, rgba(255,255,255,0.1) 10px)'}}></div>
                          </div>
                        </div>
                      )
                    })}
                  </div>
                </div>

                <div className="flex-1 overflow-hidden bg-neutral-900 flex flex-col relative">
                  {isLoading && (
                     <div className="absolute inset-0 bg-neutral-900/80 z-50 flex items-center justify-center">
                       <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
                     </div>
                  )}
                  
                  {error && (
                    <div className="absolute inset-0 bg-neutral-900/90 z-50 flex items-center justify-center p-8 text-center">
                      <div>
                        <AlertCircle className="w-12 h-12 text-red-500 mx-auto mb-4" />
                        <h2 className="text-xl font-bold text-red-400 mb-2">Error Loading Fight Data</h2>
                        <p className="text-neutral-400 max-w-md">{error}</p>
                        <p className="text-sm text-neutral-500 mt-4">Make sure the Google Sheet is published to web or set to "Anyone with link can view".</p>
                      </div>
                    </div>
                  )}

                  <div 
                    ref={timelineRef}
                    className="flex-1 overflow-auto relative"
                    style={{ scrollbarWidth: 'thin', scrollbarColor: '#404040 #171717' }}
                    onDragEnter={handleDragEnter}
                    onDragOver={handleDragOver}
                    onDrop={handleDrop}
                  >
                    <div className="relative min-h-full" style={{ width: `${timelineWidth}px` }}>
                      <div className="absolute inset-0 z-0 pointer-events-none">
                        {renderTimeMarkers()}
                      </div>

                      {/* --- BOSS TIMELINE SECTION --- */}
                      <div 
                        className="absolute top-0 left-0 right-0 bg-neutral-800/40 border-b border-neutral-700 z-10 pointer-events-none"
                        style={{ height: `${BOSS_AREA_HEIGHT}px` }}
                      >
                        <div className="sticky left-0 bg-neutral-800 px-3 py-1 text-xs font-bold text-red-400 border-b border-r border-neutral-700 inline-block rounded-br-lg z-20 pointer-events-auto">
                          Boss Timeline
                        </div>
                        
                        {fightData.map((attack, idx) => {
                          const topOffset = (idx % 4) * 40; 
                          const attackColor = getDamageColor(attack.numDamage, maxDamage);
                          const stemColor = attackColor.replace('rgb', 'rgba').replace(')', ', 0.5)');
                          
                          return (
                            <div 
                              key={idx}
                              className="absolute top-[30px] bottom-0 border-l-2 pl-1 flex flex-col pointer-events-auto"
                              style={{ left: `${attack.seconds * PIXELS_PER_SECOND}px`, borderColor: stemColor }}
                            >
                              <div 
                                className="bg-neutral-800/90 border rounded shadow-md w-[140px] px-2 py-1.5 z-20 hover:z-30 transition-colors"
                                style={{ marginTop: `${topOffset}px`, borderColor: attackColor }}
                              >
                                <div className="font-bold text-xs leading-tight mb-0.5" style={{ color: attackColor }}>{attack.name}</div>
                                {attack.damage && (
                                  <div 
                                    className="text-[10px] font-mono leading-none font-bold drop-shadow-md"
                                    style={{ color: attackColor }}
                                  >
                                    {attack.damage} {attack.type && <span className="text-neutral-500 text-[9px] font-normal">({attack.type})</span>}
                                  </div>
                                )}
                                {attack.notes && (
                                  <div className="text-blue-300 text-[10px] italic mt-1 leading-tight whitespace-normal max-h-12 overflow-hidden overflow-ellipsis">
                                    {attack.notes}
                                  </div>
                                )}
                              </div>
                            </div>
                          );
                        })}
                      </div>

                      {/* --- MITIGATION LANES --- */}
                      <div 
                        className="absolute left-0 right-0 bottom-0 z-20 pointer-events-none"
                        style={{ top: `${BOSS_AREA_HEIGHT}px` }}
                      >
                        {[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15].map(lane => (
                          <div key={lane} className="absolute w-full h-[50px] border-b border-neutral-800/50 pointer-events-none" style={{ top: `${lane * 50}px` }}></div>
                        ))}

                        {mitigations.map((mit) => {
                          const durationWidth = Math.max(mit.skill.duration * PIXELS_PER_SECOND, 10); 
                          const totalWidth = mit.skill.cd * PIXELS_PER_SECOND;
                          const laneTop = mit.lane * 50 + 5; 
                          const hpOutput = getSkillHealingTotal(mit.skill);

                          return (
                            <div
                              key={mit.id}
                              draggable
                              onDragStart={(e) => handleDragStartTimeline(e, mit)}
                              className="absolute h-[40px] flex rounded shadow-lg overflow-hidden group cursor-grab active:cursor-grabbing border border-neutral-900 hover:ring-2 ring-white z-30 pointer-events-auto"
                              style={{ 
                                left: `${mit.startTime * PIXELS_PER_SECOND}px`, 
                                top: `${laneTop}px`,
                                width: `${Math.max(durationWidth, totalWidth, 120)}px`
                              }}
                            >
                              <div 
                                className={`h-full ${mit.skill.color} pointer-events-none`}
                                style={{ width: `${durationWidth}px`, flexShrink: 0 }}
                              ></div>

                              {mit.skill.cd > mit.skill.duration && (
                                <div 
                                  className="h-full bg-neutral-700/60 flex-1 relative border-y border-r border-neutral-600/50 pointer-events-none"
                                  style={{ backgroundImage: 'repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(0,0,0,0.2) 10px, rgba(0,0,0,0.2) 20px)' }}
                                >
                                  <span className="absolute right-2 top-1/2 -translate-y-1/2 text-[10px] text-neutral-300 font-mono bg-neutral-900/60 px-1 rounded shadow">
                                    {mit.skill.cd}s CD
                                  </span>
                                </div>
                              )}

                              <div className="absolute inset-0 flex items-center px-2 pointer-events-none whitespace-nowrap overflow-hidden">
                                <span className="font-bold text-xs text-white drop-shadow-[0_1px_2px_rgba(0,0,0,0.9)]">{mit.skill.name}</span>
                                <span className="text-[10px] text-gray-200 ml-2 drop-shadow-[0_1px_2px_rgba(0,0,0,0.9)]">
                                    {mit.skill.effect} {hpOutput > 0 && <span className="text-green-300 font-mono">(~{hpOutput.toLocaleString()} HP)</span>}
                                </span>
                              </div>

                              <button 
                                onClick={(e) => { e.stopPropagation(); deleteMitigation(mit.id); }}
                                className="absolute right-1 top-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-100 p-1 bg-red-600 hover:bg-red-500 rounded text-white transition-opacity z-40"
                                title="Remove Mitigation"
                              >
                                <Trash2 className="w-3 h-3" />
                              </button>
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  </div>
                  
                  <div className="absolute bottom-4 right-4 bg-neutral-800/90 border border-neutral-700 px-3 py-2 rounded-lg text-xs text-neutral-400 flex items-center gap-2 pointer-events-none shadow-xl z-50">
                    <Info className="w-4 h-4"/> Use horizontal scroll (Shift + Scroll) to move through the fight timeline.
                  </div>
                </div>
              </div>
            </div>
          );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
